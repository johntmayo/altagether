<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Keep Altadena Together</title>
  <link rel="stylesheet" href="css/styles.css">
  <link
    href="https://fonts.googleapis.com/css2?family=Alegreya:ital,wght@0,400;0,600;0,700;1,400&family=Nunito:wght@400&display=swap"
    rel="stylesheet">
  <link rel="icon" href="assets/images/altagether.png" type="image/png">
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
  <script
    src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.min.js"></script>
  <link rel="stylesheet"
    href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.css">
</head>

<body>

  <div class="background"></div>

  <div class="central-box mapbox">
    
    <header class="main-header">
      <h1>Altagether</h1>
      <h2>Keep Altadena together.</h2>
      <div id="nav-placeholder"></div>
    </header>

    <div class="about">
      <h3>Find Your Neighborhood Captain</h3>
      <p>This interactive map represents our community's growing network of Neighborhood Captains. Search for your
        address to find your local captain, then reach out to them directly using the contact information provided. Our
        goal is to have captains throughout all of Altadena to ensure everyone has a local point of contact for support
        and information. If there isn't a captain in your area yet, please consider <a href="interest_form.html">signing
          up yourself!</a></p>
    </div>

    <div id="map" class="mapboxgl-map">

      <!--  Toggle Controls -->        
      <div id="toggleDINSContainer">
        <div id="legendTitle">
          <input type="checkbox" id="toggleDINS">
          <label for="toggleDINS">Damage</label>
        </div>
        <!-- Legend: Hidden by default; only shows when toggleDINS is checked -->
        <div id="dinsLegend">
          <span class="legend-item">
            <span class="legend-circle" style="background: red;"></span>Destroyed
          </span>
          <span class="legend-item">
            <span class="legend-circle" style="background: yellow;"></span>Damaged
          </span>
          <span class="legend-item">
            <span class="legend-circle" style="background: green;"></span>No Damage
          </span>
        </div>
        <!-- New “Perimeter” toggle (starts OFF) -->
        <div id="perimeterTitle">
          <input type="checkbox" id="togglePerimeter">
          <label for="togglePerimeter">Perimeter</label>
        </div>
      </div>

      <!-- Mapbox canvas and control container -->
      <div class="mapboxgl-canary" style="visibility: hidden;"></div>
      <div class="mapboxgl-canvas-container mapboxgl-interactive mapboxgl-touch-drag-pan mapboxgl-touch-zoom-rotate">
        <canvas class="mapboxgl-canvas" tabindex="0" aria-label="Map" role="region" width="1600" height="1200"
          style="width: 800px; height: 600px;"></canvas>
      </div>
      <div class="mapboxgl-control-container">
        <div class="mapboxgl-ctrl-top-left"></div>
        <div class="mapboxgl-ctrl-top-right">
          <div class="mapboxgl-ctrl-geocoder mapboxgl-ctrl">
            <svg class="mapboxgl-ctrl-geocoder--icon mapboxgl-ctrl-geocoder--icon-search" viewBox="0 0 18 18"
              xml:space="preserve" width="18" height="18">
              <path
                d="M7.4 2.5c-2.7 0-4.9 2.2-4.9 4.9s2.2 4.9 4.9 4.9c1 0 1.8-.2 2.5-.8l3.7 3.7c.2.2.4.3.8.3.7 0 1.1-.4 1.1-1.1 0-.3-.1-.5-.3-.8L11.4 10c.4-.8.8-1.6.8-2.5.1-2.8-2.1-5-4.8-5zm0 1.6c1.8 0 3.2 1.4 3.2 3.2s-1.4 3.2-3.2 3.2-3.3-1.3-3.3-3.1 1.4-3.3 3.3-3.3z">
              </path>
            </svg>
            <input type="text" class="mapboxgl-ctrl-geocoder--input" placeholder="Search for your address"
              aria-label="Search for your address">
            <div class="suggestions-wrapper">
              <ul class="suggestions" style="display: none;"></ul>
            </div>
            <div class="mapboxgl-ctrl-geocoder--pin-right">
              <button aria-label="Clear" class="mapboxgl-ctrl-geocoder--button">
                <svg class="mapboxgl-ctrl-geocoder--icon mapboxgl-ctrl-geocoder--icon-close" viewBox="0 0 18 18"
                  xml:space="preserve" width="18" height="18">
                  <path
                    d="M3.8 2.5c-.6 0-1.3.7-1.3 1.3 0 .3.2.7.5.8L7.2 9 3 13.2c-.3.3-.5.7-.5 1 0 .6.7 1.3 1.3 1.3.3 0 .7-.2 1-.5L9 10.8l4.2 4.2c.2.3.7.3 1 .3.6 0 1.3-.7 1.3-1.3 0-.3-.2-.7-.3-1l-4.4-4L15 4.6c.3-.2.5-.5.5-.8 0-.7-.7-1.3-1.3-1.3-.3 0-.7.2-1 .3L9 7.1 4.8 2.8c-.3-.1-.7-.3-1-.3z">
                  </path>
                </svg>
              </button>
              <svg class="mapboxgl-ctrl-geocoder--icon mapboxgl-ctrl-geocoder--icon-loading" viewBox="0 0 18 18"
                xml:space="preserve" width="18" height="18">
                <path fill="#333" d="M4.4 4.4l.8.8c2.1-2.1 5.5-2.1 7.6 0l.8-.8c-2.5-2.5-6.7-2.5-9.2 0z"></path>
                <path opacity=".1"
                  d="M12.8 12.9c-2.1 2.1-5.5 2.1-7.6 0-2.1-2.1-2.1-5.5 0-7.7l-.8-.8c-2.5 2.5-2.5 6.7 0 9.2s6.6 2.5 9.2 0 2.5-6.6 0-9.2l-.8.8c2.2 2.1 2.2 5.6 0 7.7z">
                </path>
              </svg>
            </div>
          </div>
        </div>
      </div>
      <div class="mapboxgl-ctrl-bottom-left">
        <div class="mapboxgl-ctrl" style="display: block;">
          <a class="mapboxgl-ctrl-logo" target="_blank" rel="noopener nofollow" href="https://www.mapbox.com/"
            aria-label="Mapbox logo"></a>
        </div>
      </div>
      <div class="mapboxgl-ctrl-bottom-right">
        <div class="mapboxgl-ctrl mapboxgl-ctrl-attrib">
          <button class="mapboxgl-ctrl-attrib-button" type="button" aria-label="Toggle attribution">
            <span class="mapboxgl-ctrl-icon" aria-hidden="true" title="Toggle attribution"></span>
          </button>
          <div class="mapboxgl-ctrl-attrib-inner" role="list">
            <a href="https://www.mapbox.com/about/maps/" target="_blank" title="Mapbox" aria-label="Mapbox">© Mapbox</a>
            <a href="https://www.openstreetmap.org/about/" target="_blank" title="OpenStreetMap"
              aria-label="OpenStreetMap">© OpenStreetMap</a>
            <a class="mapbox-improve-map"
              href="https://apps.mapbox.com/feedback/?owner=mapbox&amp;id=streets-v11&amp;access_token=pk.eyJ1IjoiYWx0YWdldGhlciIsImEiOiJjbTY0ZWdqMDkweHZ4MnBwdTg3OGVrbmhyIn0.FyctMHs1MC4EUbDY56-AoA#/-118.13761/34.18942/12.5"
              target="_blank" aria-label="Map feedback" rel="noopener nofollow">Improve this map</a>
          </div>
        </div>
      </div>




<!-- JavaScript for Mapbox + Toggles -->

<script>
  document.addEventListener('DOMContentLoaded', function () {
    console.log("Script loaded and DOM is ready");

    mapboxgl.accessToken = 'pk.eyJ1IjoiYWx0YWdldGhlciIsImEiOiJjbTY0ZWdqMDkweHZ4MnBwdTg3OGVrbmhyIn0.FyctMHs1MC4EUbDY56-AoA';
    let currentStyle = 'streets-v11';

    // Initialize the map — lock rotation/tilt here
    const map = new mapboxgl.Map({
      container: 'map',
      style: `mapbox://styles/mapbox/${currentStyle}`,
      center: [-118.135610, 34.192420],
      zoom: 13,
      bearing: 0,             // start unrotated
      pitch: 0,               // start untilted
      dragRotate: false,      // disable right-click/ctrl-drag rotate
      pitchWithRotate: false, // disable tilting with rotation gestures
      maxPitch: 0             // hard-stop any tilt
    });

    // Ensure only panning & zooming are allowed (disable every rotation path)
    map.on('load', () => {
      map.dragRotate.disable();                // mouse/trackpad rotation
      map.touchZoomRotate.disableRotation();   // pinch-rotate on touch
      map.keyboard.disableRotation?.();        // arrow+rotate keys (if supported)
      map.setBearing(0);
      map.setPitch(0);

      // (Optional) make sure pan/zoom interactions stay enabled
      map.dragPan.enable();
      map.scrollZoom.enable();
      map.doubleClickZoom.enable();
      map.boxZoom.enable();
    });
  
    // Add polygon source & layers
    function addCustomLayers() {
      if (!map.getSource('polygons')) {
        map.addSource('polygons', {
          type: 'vector',
          url: 'mapbox://altagether.cm64fisju135z1qqmifs0zty5-4swrp',
          promoteId: 'ZoneName'
        });
      }
      if (!map.getLayer('polygon-layer')) {
        map.addLayer({
          id: 'polygon-layer',
          type: 'fill',
          source: 'polygons',
          'source-layer': 'zones',
          paint: {
            'fill-color': [
              'case',
              ['boolean', ['feature-state', 'hover'], false],
              '#f57c00',
              ['case', ['==', ['get', 'Status'], 'Confirmed'], '#185edd', '#006CC4']
            ],
            'fill-opacity': [
              'case',
              ['boolean', ['feature-state', 'hover'], false],
              0.2,
              ['case', ['==', ['get', 'Status'], 'Confirmed'], 0.2, 0.05]
            ]
          }
        });
      }
      if (!map.getLayer('polygon-outline')) {
        map.addLayer({
          id: 'polygon-outline',
          type: 'line',
          source: 'polygons',
          'source-layer': 'zones',
          paint: {
            'line-color': '#0c41a1',
            'line-width': 1.5,
            'line-opacity': 0.5
          }
        });
      }
    }

    // Add DINS LAYER
    function addDINSLayer() {
      console.log("Adding DINS layer");
      if (!map.getSource('dins')) {
        map.addSource('dins', {
          type: 'vector',
          url: 'mapbox://altagether.bu6l5c8j'
        });
      }
      if (!map.getLayer('dins-layer')) {
        map.addLayer({
          id: 'dins-layer',
          type: 'circle',
          source: 'dins',
          'source-layer': 'DINS_2025_Eaton_Public_View-0zn1cz',
          paint: {
            'circle-radius': 2.5,
            'circle-color': [
              'case',
              ['==', ['get', 'DAMAGE'], 'No Damage'], 'green',
              ['==', ['get', 'DAMAGE'], 'Affected (1-9%)'], 'yellow',
              ['==', ['get', 'DAMAGE'], 'Minor (10-25%)'], 'yellow',
              ['==', ['get', 'DAMAGE'], 'Major (26-50%)'], 'yellow',
              ['==', ['get', 'DAMAGE'], 'Destroyed (>50%)'], 'red',
              '#000000'
            ]
          }
        });
      } else {
        map.setLayoutProperty('dins-layer', 'visibility', 'visible');
      }
    }

    function removeDINSLayer() {
      console.log("Removing DINS layer");
      if (map.getLayer('dins-layer')) {
        map.setLayoutProperty('dins-layer', 'visibility', 'none');
      }
    }

    // Add Perimeter Layer
    function addPerimeterLayer() {
      console.log("Adding Perimeter layer");
      if (!map.getSource('perimeter')) {
        map.addSource('perimeter', {
          type: 'vector',
          url: 'mapbox://altagether.21obglbu'
        });
      }
      if (!map.getLayer('perimeter-layer')) {
        map.addLayer({
          id: 'perimeter-layer',
          type: 'line',
          source: 'perimeter',
          'source-layer': 'Eaton_Perimeter_20250121-bhnm45',
          paint: {
            'line-color': '#FF00FF',
            'line-width': 2
          }
        });
      } else {
        map.setLayoutProperty('perimeter-layer', 'visibility', 'visible');
      }
    }

    function removePerimeterLayer() {
      console.log("Removing Perimeter layer");
      if (map.getLayer('perimeter-layer')) {
        map.setLayoutProperty('perimeter-layer', 'visibility', 'none');
      }
    }

    // Helper to show a "no zone" popup 
    function showNoZonePopup(lngLat) {
      // Close any existing popup at this location by creating a new one
      new mapboxgl.Popup({ offset: 12, closeOnClick: true })
        .setLngLat(lngLat)
        .setHTML(`
          <div class="no-zone-popup" style="max-width:260px;">
            <h3 style="margin:0 0 6px 0;font-size:16px;line-height:1.2;">No zone established here yet</h3>
            <p style="margin:0 0 10px 0;font-size:13px;line-height:1.4;">
              A zone hasn't been set up for this area. Want to help make it happen?
            </p>
            <a href="https://altagether.org/interest_form.html" target="_blank" rel="noopener"
               style="display:inline-block;padding:10px 14px;border-radius:4px;
                      background:#527c2c;color:#fff;text-decoration:none;font-weight:600;
                      ">
              Become a Neighborhood Captain
            </a>
          </div>
        `)
        .addTo(map);
    }

    // Utility: check if a given lngLat is inside any rendered polygon
    function isInsideAnyZone(lngLat) {
      const point = map.project(lngLat);
      const hits = map.queryRenderedFeatures(point, { layers: ['polygon-layer'] });
      return hits && hits.length > 0;
    }

    // Once the map loads, add base layers (no toggles run initially)
    map.on('load', () => {
      addCustomLayers();

      // Neither DINS nor Perimeter is checked by default, so nothing is added here.

      // Add the geocoder control
      const geocoder = new MapboxGeocoder({
        accessToken: mapboxgl.accessToken,
        mapboxgl: mapboxgl,
        marker: true,
        placeholder: 'Search for your address'
      });
      map.addControl(geocoder);

      // Hover interaction for polygons
      let hoveredId = null;
      map.on('mouseenter', 'polygon-layer', () => {
        map.getCanvas().style.cursor = 'pointer';
      });
      map.on('mouseleave', 'polygon-layer', () => {
        map.getCanvas().style.cursor = '';
        if (hoveredId !== null) {
          map.setFeatureState(
            { source: 'polygons', sourceLayer: 'zones', id: hoveredId },
            { hover: false }
          );
        }
        hoveredId = null;
      });
      map.on('mousemove', 'polygon-layer', (e) => {
        if (e.features.length > 0) {
          const feature = e.features[0];
          if (hoveredId !== null && hoveredId !== feature.id) {
            map.setFeatureState(
              { source: 'polygons', sourceLayer: 'zones', id: hoveredId },
              { hover: false }
            );
          }
          hoveredId = feature.id;
          map.setFeatureState(
            { source: 'polygons', sourceLayer: 'zones', id: hoveredId },
            { hover: true }
          );
        }
      });

      // Popup for polygon-layer clicks
      function generateCaptainInfo(properties) {
        const names = properties.ContactName ? properties.ContactName.split(';') : [];
        const phones = properties.ContactPhone ? properties.ContactPhone.split(';') : [];
        const emails = properties.ContactEmail ? properties.ContactEmail.split(';') : [];
        let captainInfo = "";
        for (let i = 0; i < names.length; i++) {
          captainInfo += `
                <div class="captain-block">
                  <p><span class="prop-label"><strong>Captain ${i + 1}:</strong></span><span class="prop-value">${names[i] || 'N/A'}</span></p>
                  <p><span class="prop-label">Phone:</span><span class="prop-value">${phones[i] || 'N/A'}</span></p>
                  <p><span class="prop-label">Email:</span><span class="prop-value">${emails[i] || 'N/A'}</span></p>
                </div>
              `;
        }
        return captainInfo;
      }

      map.on('click', 'polygon-layer', (e) => {
        const properties = e.features[0].properties;
        const captainInfo = generateCaptainInfo(properties);
        const statusClass = properties.Status === 'Confirmed' ? 'confirmed' : '';
        new mapboxgl.Popup()
          .setLngLat(e.lngLat)
          .setHTML(`
                <div class="popup-header">
                  <h3>${properties.ZoneName || 'N/A'}</h3>
                  <span class="status ${statusClass}">${properties.Status || 'N/A'}</span>
                </div>
                ${captainInfo}
              `)
          .addTo(map);
      });

      /* Show "no zone" when clicking outside polygons */
      map.on('click', (e) => {
        const hits = map.queryRenderedFeatures(e.point, { layers: ['polygon-layer'] });
        if (!hits || hits.length === 0) {
          showNoZonePopup(e.lngLat);
        }
      });

      // Show "no zone" when geocoder result is outside polygons
      geocoder.on('result', (ev) => {
        const lngLat = { lng: ev.result.center[0], lat: ev.result.center[1] };
        if (!isInsideAnyZone(lngLat)) {
          showNoZonePopup(lngLat);
        }
      });
    });

    // If the style is toggled (e.g. streets ↔ satellite), re‐add any layers whose checkboxes are checked
    map.on('style.load', () => {
      addCustomLayers();
      if (document.getElementById('toggleDINS').checked) {
        addDINSLayer();
      }
      if (document.getElementById('togglePerimeter').checked) {
        addPerimeterLayer();
      }
    });

    // Style‐toggle button logic (if you have a button with id="toggleStyle")
    const styleToggleButton = document.getElementById('toggleStyle');
    if (styleToggleButton) {
      styleToggleButton.addEventListener('click', () => {
        currentStyle = (currentStyle === 'streets-v11') ? 'satellite-v9' : 'streets-v11';
        map.setStyle(`mapbox://styles/mapbox/${currentStyle}`);
      });
    }

    // DINS Toggle Event Listener
    document.getElementById('toggleDINS').addEventListener('change', (e) => {
      console.log("DINS checkbox changed:", e.target.checked);
      const legend = document.getElementById('dinsLegend');
      if (e.target.checked) {
        addDINSLayer();
        legend.style.display = 'inline-flex';
      } else {
        removeDINSLayer();
        legend.style.display = 'none';
      }
    });

    // Perimeter Toggle Event Listener
    document.getElementById('togglePerimeter').addEventListener('change', (e) => {
      console.log("Perimeter checkbox changed:", e.target.checked);
      if (e.target.checked) {
        addPerimeterLayer();
      } else {
        removePerimeterLayer();
      }
    });

  });
</script>




    </div>

    <p class="map-note">This map exists to help neighbors find each other, connect, and organize in the wake of a
      disaster that upended our lives. It is a tool for mutual aid, not a marketing list. If you are a business or
      third-party organization using this map to solicit Neighborhood Captains, please reconsider. It's not just
      inappropriate — it undermines the spirit of community recovery we’re trying to build. Do better.</p>

    <script src="js/main.js"></script>

    <script>
      // Load navigation
      fetch('nav.html')
        .then(response => response.text())
        .then(data => {
          document.getElementById('nav-placeholder').innerHTML = data;
        })
        .catch(error => console.error('Error loading navigation:', error));
    </script>
</body>

</html>
